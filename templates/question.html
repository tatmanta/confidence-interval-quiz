{% extends "base.html" %}

{% block content %}

<!-- ============================
     PROGRESS HEADER
=============================== -->
<div class="mb-3">
  <div class="d-flex justify-content-between mb-1">
    <small>Question {{ index + 1 }} of {{ total }}</small>
    <small>{{ progress }}% complete</small>
  </div>

  <div class="progress" style="height: 10px;">
    <div
      class="progress-bar"
      role="progressbar"
      style="width: {{ progress }}%;"
      aria-valuenow="{{ progress }}"
      aria-valuemin="0"
      aria-valuemax="100"
    ></div>
  </div>
</div>

<!-- ============================
     QUESTION CARD
=============================== -->
<div class="card">
  <div class="card-body">

    {# question.text should be BASE TEXT (no units baked in) #}
    <h5
      class="card-title"
      id="questionTitle"
      data-base-text="{{ question.text|e }}"
      data-unit-kind="{{ question.unit_kind|default('')|e }}"
    >
      {{ question.text }}
    </h5>

    <form method="post" class="mt-3">

      <!-- ============================
           UNITS TOGGLE
      =============================== -->
      <div class="d-flex justify-content-end mb-2">
        <div class="d-flex align-items-center gap-2">
          <small class="text-muted">Units</small>

          <select
            id="unitSystem"
            class="form-select form-select-sm"
            style="width:auto;"
            data-default="{{ default_unit_system|default('imperial') }}"
          >
            <option value="metric">Metric</option>
            <option value="imperial">US / Imperial</option>
          </select>
        </div>
      </div>

      <!-- Posted with form (server can use it) -->
      <input type="hidden" id="unit_system" name="unit_system" value="">
      {% if question.unit_kind %}
        <input type="hidden" id="unit_kind" name="unit_kind" value="{{ question.unit_kind }}">
      {% endif %}

      <!-- ============================
           INPUT FIELDS + NEXT BUTTON
      =============================== -->
      <div class="row g-4 align-items-end">

        <div class="col-md-4">
          <label for="lower" class="form-label">Lower bound</label>
          <input
            type="text"
            inputmode="decimal"
            class="form-control"
            id="lower"
            name="lower"
            value="{{ lower_value }}"
            placeholder="e.g., 12,000 or 10M"
            required
          >
        </div>

        <div class="col-md-4">
          <label for="upper" class="form-label">Upper bound</label>
          <input
            type="text"
            inputmode="decimal"
            class="form-control"
            id="upper"
            name="upper"
            value="{{ upper_value }}"
            placeholder="e.g., 25,000 or 3.2B"
            required
          >
        </div>

        <div class="col-md-4 d-flex justify-content-end">
          <button type="submit" class="btn next-button w-100">
            {% if index + 1 == total %}See results{% else %}Next{% endif %}
          </button>
        </div>

      </div>

      <!-- ============================
           ERROR MESSAGE
      =============================== -->
      {% if error %}
        <div class="alert alert-danger mt-3">
          {{ error }}
        </div>
      {% endif %}

      <!-- ============================
           BACK BUTTON
      =============================== -->
      <div class="mt-4">
        {% if index > 0 %}
          <a href="{{ url_for('question', index=index-1) }}" class="btn back-button">
            ← Back
          </a>
        {% endif %}
      </div>

      <!-- ============================
           UNITS: persist + title suffix + optional conversion
      =============================== -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const unitSelect = document.getElementById("unitSystem");
          const unitHidden = document.getElementById("unit_system");
          const kindEl = document.getElementById("unit_kind");
          const titleEl = document.getElementById("questionTitle");
          const lower = document.getElementById("lower");
          const upper = document.getElementById("upper");

          if (!unitSelect || !unitHidden || !titleEl) return;

          // 1) Choose unit system on load:
          //    - user preference (localStorage) wins
          //    - else server default (geo-ish) wins
          //    - else imperial fallback
          const saved = localStorage.getItem("ci_unitSystem");
          const serverDefault = unitSelect.dataset.default;

          if (saved === "metric" || saved === "imperial") {
            unitSelect.value = saved;
          } else if (serverDefault === "metric" || serverDefault === "imperial") {
            unitSelect.value = serverDefault;
          } else {
            unitSelect.value = "imperial";
          }

          // Keep hidden in sync (server reads this on POST)
          unitHidden.value = unitSelect.value;

          // 2) Map unit kinds to readable labels per system
          //    IMPORTANT: these keys must match question.unit_kind values in your question bank.
          const UNIT_SUFFIX = {
            // heights/lengths
            height:   { metric: "in centimeters", imperial: "in inches" },
            length:   { metric: "in centimeters", imperial: "in inches" },

            // distances
            distance: { metric: "in kilometers",  imperial: "in miles"  },

            // weights
            weight:   { metric: "in kilograms",   imperial: "in pounds" },

            // temps
            temp:     { metric: "in °C",          imperial: "in °F"     }
          };

          function updateQuestionTitle() {
            const base = titleEl.dataset.baseText || "";
            const kind = titleEl.dataset.unitKind || "";
            const system = unitSelect.value;

            const suffix = (kind && UNIT_SUFFIX[kind] && UNIT_SUFFIX[kind][system])
              ? UNIT_SUFFIX[kind][system]
              : "";

            titleEl.textContent = suffix ? `${base} (${suffix})` : base;
          }

          updateQuestionTitle();

          // 3) On change:
          //    - persist preference for next questions
          //    - update title
          //    - optionally convert existing inputs if functions exist
          unitSelect.addEventListener("change", () => {
            const prev = unitHidden.value;
            const next = unitSelect.value;

            localStorage.setItem("ci_unitSystem", next);
            unitHidden.value = next;

            updateQuestionTitle();

            // Optional conversion only if you have unit_kind AND conversion helpers exist
            if (!kindEl) return;

            const kind = kindEl.value;

            // Guard if conversion helpers aren't present
            if (typeof parseShorthandNumber !== "function" ||
                typeof convertValue !== "function" ||
                typeof formatWithSeparators !== "function") {
              return;
            }

            const l = parseShorthandNumber(lower.value);
            const u = parseShorthandNumber(upper.value);

            if (l != null) {
              const converted = convertValue(l, kind, prev, next);
              if (converted != null) lower.value = formatWithSeparators(String(converted));
            }
            if (u != null) {
              const converted = convertValue(u, kind, prev, next);
              if (converted != null) upper.value = formatWithSeparators(String(converted));
            }
          });
        });
      </script>

    </form>
  </div>
</div>

{% endblock %}

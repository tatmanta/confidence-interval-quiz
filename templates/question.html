{% extends "base.html" %}

{% block content %}

<!-- ============================
     PROGRESS HEADER
=============================== -->
<div class="mb-3">
  <div class="d-flex justify-content-between mb-1">
    <small>Question {{ index + 1 }} of {{ total }}</small>
    <small>{{ progress }}% complete</small>
  </div>

  <div class="progress" style="height: 10px;">
    <div
      class="progress-bar"
      role="progressbar"
      style="width: {{ progress }}%;"
      aria-valuenow="{{ progress }}"
      aria-valuemin="0"
      aria-valuemax="100"
    ></div>
  </div>
</div>

<!-- ============================
     QUESTION CARD
=============================== -->
<div class="card">
  <div class="card-body">
    <h5 class="card-title">{{ question.text }}</h5>

    <form method="post" class="mt-3">

      <!-- ============================
           UNITS TOGGLE
      =============================== -->
      <div class="d-flex justify-content-end mb-2">
        <div class="d-flex align-items-center gap-2">
          <small class="text-muted">Units</small>
          <select id="unitSystem" class="form-select form-select-sm" style="width:auto;">
            <option value="metric">Metric</option>
            <option value="imperial">US / Imperial</option>
          </select>
        </div>
      </div>

      <!-- Posted with form (server can use it) -->
      <input type="hidden" id="unit_system" name="unit_system" value="">
      {% if question.unit_kind %}
        <input type="hidden" id="unit_kind" name="unit_kind" value="{{ question.unit_kind }}">
      {% endif %}

      <!-- ============================
           INPUT FIELDS + NEXT BUTTON
      =============================== -->
      <div class="row g-4 align-items-end">

        <div class="col-md-4">
          <label for="lower" class="form-label">Lower bound</label>
          <input
            type="text"
            inputmode="decimal"
            class="form-control"
            id="lower"
            name="lower"
            value="{{ lower_value }}"
            placeholder="e.g., 12,000 or 10M"
            required
          >
        </div>

        <div class="col-md-4">
          <label for="upper" class="form-label">Upper bound</label>
          <input
            type="text"
            inputmode="decimal"
            class="form-control"
            id="upper"
            name="upper"
            value="{{ upper_value }}"
            placeholder="e.g., 25,000 or 3.2B"
            required
          >
        </div>

        <!-- FULL-WIDTH NEXT BUTTON in remaining column -->
        <div class="col-md-4 d-flex justify-content-end">
          <button type="submit" class="btn next-button w-100">
            {% if index + 1 == total %}See results{% else %}Next{% endif %}
          </button>
        </div>

      </div>

      <!-- ============================
           ERROR MESSAGE
      =============================== -->
      {% if error %}
        <div class="alert alert-danger mt-3">
          {{ error }}
        </div>
      {% endif %}

      <!-- ============================
           BACK BUTTON (PILL, SMALLER)
      =============================== -->
      <div class="mt-4">
        {% if index > 0 %}
          <a href="{{ url_for('question', index=index-1) }}" class="btn back-button">
            ‚Üê Back
          </a>
        {% endif %}
      </div>

      <!-- ============================
           SYNC UNIT STATE + OPTIONAL CONVERSION
      =============================== -->
      <script>
        document.addEventListener("DOMContentLoaded", () => {
          const unitSelect = document.getElementById("unitSystem");
          const unitHidden = document.getElementById("unit_system");
          const kindEl = document.getElementById("unit_kind");
          const lower = document.getElementById("lower");
          const upper = document.getElementById("upper");

          if (!unitSelect || !unitHidden) return;

          // Ensure hidden field matches current selection on load
          unitHidden.value = unitSelect.value;

          unitSelect.addEventListener("change", () => {
            const prev = unitHidden.value;
            const next = unitSelect.value;
            unitHidden.value = next;

            // If no per-question unit kind exists, just store preference and stop.
            if (!kindEl) return;

            const kind = kindEl.value;

            // Convert current inputs if parseable (handles commas + K/M/B/T)
            const l = parseShorthandNumber(lower.value);
            const u = parseShorthandNumber(upper.value);

            if (l != null) {
              const converted = convertValue(l, kind, prev, next);
              if (converted != null) lower.value = formatWithSeparators(String(converted));
            }
            if (u != null) {
              const converted = convertValue(u, kind, prev, next);
              if (converted != null) upper.value = formatWithSeparators(String(converted));
            }
          });
        });
      </script>

    </form>
  </div>
</div>

{% endblock %}
